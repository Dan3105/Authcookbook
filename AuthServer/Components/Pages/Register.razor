@* PSEUDOCODE / PLAN:
   - When the form is valid and submitted:
     1. Call registrationService.RegisterUser(...) with username and password from the model.
     2. If the call succeeds:
        - Set a local flag `submitted = true` to show success UI.
        - Optionally clear or reset the model.
        - Invoke a browser notification via IJSRuntime (simple alert) to immediately announce registration completion.
        - Provide an ARIA live region so screen readers are notified.
     3. If the call fails:
        - Capture the exception message and show an error alert in the UI.
   - Add an `errorMessage` field to display errors.
   - Inject `IJSRuntime` for the alert call.
*@

@page "/register"
@using System.ComponentModel.DataAnnotations
@using AuthServer.Model.UserModel
@using AuthServer.Services.Registration
@inject IRegistrationService registrationService;
@inject IJSRuntime jsRuntime;

<PageTitle>Register</PageTitle>

<h1>Register</h1>

<p>Please provide a user name and password. All fields are required and passwords must match.</p>

<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="username" class="form-label">User name</label>
        <InputText id="username" class="form-control" @bind-Value="model.Username" />
        <ValidationMessage For="() => model.Username" />
    </div>

    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <InputText id="email" class="form-control" @bind-Value="model.Email" />
        <ValidationMessage For="() => model.Email" />
    </div>

    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <InputText id="password" type="password" class="form-control" @bind-Value="model.Password" />
        <ValidationMessage For="() => model.Password" />
    </div>

    <div class="mb-3">
        <label for="confirmPassword" class="form-label">Confirm password</label>
        <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="model.ConfirmPassword" />
        <ValidationMessage For="() => model.ConfirmPassword" />
    </div>

    <button type="submit" class="btn btn-primary">Register</button>
</EditForm>

@if (string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3" role="alert">
        @errorMessage
    </div>
}

@if (submitted)
{
    <!-- ARIA live region to announce success to assistive tech -->
    <div class="alert alert-success mt-3" role="status" aria-live="polite">
        Registration submitted.
    </div>
}

@code {
    private RegisterModel model = new();
    private bool submitted;
    private string? errorMessage;

    private async Task HandleValidSubmit()
    {
        errorMessage = null;
        try
        {
            var result = await registrationService.RegisterUser(new UserRegistrationDTO
            {
                username = model.Username,
                password = model.ConfirmPassword,
                email = model.Email
            });

            // Mark submitted so UI shows confirmation
            submitted = true;

            // Announce to the user immediately (simple browser alert)
            // This complements the ARIA live region for screen readers.
            if (result.IsSuccess)
            {
                await jsRuntime.InvokeVoidAsync("alert", "Registration submitted.");

                // Optional: reset form model
                model = new RegisterModel();
            } else
            {
                await jsRuntime.InvokeVoidAsync("alert", $"Registration failed with {result.Message}");
            }

            // If you prefer navigation to a login page instead of alert:
            // navManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            // Surface a readable error message in the UI
            errorMessage = $"Registration failed: {ex.Message}";
            submitted = false;
        }
    }

    private class RegisterModel
    {
        [Required(ErrorMessage = "User name is required")]
        public string? Username { get; set; }

        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string? Email { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [DataType(DataType.Password)]
        public string? Password { get; set; }

        [Required(ErrorMessage = "Confirm password is required")]
        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "Passwords do not match")]
        public string? ConfirmPassword { get; set; }
    }
}